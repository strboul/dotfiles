#!/usr/bin/env bash

# A CLI to easily clean all Docker resources per type
#
# Usage:
# docker-remove-all -t [containers|images|volumes|networks] -y
#
# It's possible to pass multiple arguments,
# docker-remove-all -t containers -t images -y
#
# If no argument provided, it'll remove all.
#

set -e

source "$HOME"/dotfiles/zsh/utils.sh

utils__stop_if_not_command_exists "docker"

# ----- utils -----------------------------------------------------------------

message_info() {
  utils__message__color_message "purple" ">>> $1"
}

count_lines() {
  echo "$1" | wc -l
}

stop_if_type_not_found() {
  local type="$1"
  local arr=("${@:2}")
  if [ -z "${arr[*]}" ]; then
    utils__log__error "no $type found. Skipping."
    exit 1
  fi
}

ask_prompt() {
  local name="$1"
  local fun="$2"
  local subfun="$3"
  local arr=("${@:4}")
  local cmd
  stop_if_type_not_found "$name" "${arr[@]}"
  message_info "$name to be removed:" && echo "${arr[@]}"
  cmd=("$fun" "$subfun" "$name" "${arr[@]}")
  if [ "$noprompt" == true ]; then
    "${cmd[@]}"
  else
    prompt="$(utils__yesno_prompt "Are you sure")"
    if [ "$prompt" == "y" ]; then
      "${cmd[@]}"
    fi
  fi
}

do_remove() {
  local fun="$1"
  local input_name="$2"
  local input=("${@:3})")
  local input_ids
  input_ids="$(echo "${input[@]}" | awk '{ print $3 }' | uniq)"
  "$fun" "${input_ids[@]}"
  utils__log__success \
    "removed $(count_lines "$input_ids") unique $input_name id(s)"
}

# ----- get -------------------------------------------------------------------

get_images() {
  docker images | awk '{ if (NR > 1) { if (NF > 0) { print $0 } } }'
}

get_containers() {
  docker ps -qa
}

get_volumes() {
  docker volume ls -qf dangling=true
}

get_networks() {
  docker network ls | awk '$2 != "bridge" && $3 == "bridge" { print $1 }'
}

# ----- remove ----------------------------------------------------------------

remove_images() {
  local arr=("${@}")
  docker rmi -f "${arr[@]}"
}

remove_containers() {
  local ids="$1"
  docker rm -f "${ids}"
}

remove_volumes() {
  local names
  local names_arr
  vol_names="$(get_volumes)"
  readarray -t vol_names_arr <<< "${vol_names}"
  docker volume rm "${vol_names_arr[@]}"
}

remove_networks() {
  local ids
  local ids_arr
  ids="$(get_networks)"
  readarray -t ids_arr <<< "${ids}"
  docker network rm "${ids_arr[@]}"
}

# ----- main ------------------------------------------------------------------

main_images() {
  local img
  img="$(get_images)"
  ask_prompt "images" do_remove remove_images "${img[@]}"
}

# TODO
main_containers() {
  local cont
  cont="$(get_containers)"
  ask_prompt "containers" do_remove remove_containers "${cont[@]}"
}

# ----- CLI -------------------------------------------------------------------

usage() {
  cat <<EOM
Usage: $(basename "$0") [OPTIONS...]

  -t  [containers|images|volumes|networks]  Optional. removal type of description
                                            If empty, all types are removed.
  -y                                        don't ask prompt
  -h                                        display help
EOM
  exit 2
}

noprompt=false

while getopts ":t:h:y" opt; do
  case "$opt" in
    t) types+=("$OPTARG") ;;
    y) noprompt=true ;;
    h|*) usage ;;
  esac
done
shift $((OPTIND -1))

for val in "${types[@]}"; do
  if [ "$val" == "containers" ]; then main_containers; fi
  if [ "$val" == "images" ]; then main_images; fi
  if [ "$val" == "volumes" ]; then main_volumes; fi
  if [ "$val" == "networks" ]; then main_networks; fi
done
